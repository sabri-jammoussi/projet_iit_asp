using Back.Data.Infrastructure.EF.Models;
using back.Repositories.Interfaces;
using Back.Data.Infrastructure.EF;
using Microsoft.EntityFrameworkCore;

namespace back.Repositories.Implementations;

/// <summary>
/// Repository implementation for Order entity.
/// Uses EF Core for data access.
/// </summary>
public class OrderRepository : IOrderRepository
{
    private readonly OltpDbContext _dbContext;

    public OrderRepository(OltpDbContext dbContext)
    {
        _dbContext = dbContext;
    }

    public async Task<IEnumerable<OrderDao>> GetAllAsync()
    {
        return await _dbContext.Orders
            .Include(o => o.Customer)
            .Include(o => o.OrderDetails)
            .AsNoTracking()
            .ToListAsync();
    }

    public async Task<OrderDao?> GetByIdAsync(int id)
    {
        return await _dbContext.Orders
            .Include(o => o.Customer)
            .Include(o => o.OrderDetails)
                .ThenInclude(od => od.Product)
            .FirstOrDefaultAsync(o => o.Id == id);
    }

    public async Task<IEnumerable<OrderDao>> GetByCustomerIdAsync(int customerId)
    {
        return await _dbContext.Orders
            .Where(o => o.CustomerId == customerId)
            .Include(o => o.OrderDetails)
            .AsNoTracking()
            .ToListAsync();
    }

    public async Task<OrderDao> AddAsync(OrderDao order)
    {
        _dbContext.Orders.Add(order);
        await _dbContext.SaveChangesAsync();
        return order;
    }

    public async Task<OrderDao> UpdateAsync(OrderDao order)
    {
        _dbContext.Orders.Update(order);
        await _dbContext.SaveChangesAsync();
        return order;
    }

    public async Task<bool> DeleteAsync(int id)
    {
        var order = await _dbContext.Orders.FindAsync(id);
        if (order == null)
            return false;

        _dbContext.Orders.Remove(order);
        await _dbContext.SaveChangesAsync();
        return true;
    }

    public async Task<bool> ExistsAsync(int id)
    {
        return await _dbContext.Orders.AnyAsync(o => o.Id == id);
    }
}
