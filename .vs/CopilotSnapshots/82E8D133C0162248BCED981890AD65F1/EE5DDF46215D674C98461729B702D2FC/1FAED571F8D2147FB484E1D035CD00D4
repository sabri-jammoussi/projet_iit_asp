using Azure.Core;
using back.Models.Authentification;
using Back.Commun.Security;
using Back.Data.Infrastructure.EF;
using Microsoft.AspNetCore.Mvc;

namespace back.Services;

public class AuthService
{
	private readonly ILogger<AuthService> _logger;
	private readonly OltpDbContext _dbContext;
	private readonly PasswordHasherProvider _passwordHasherProvider;
	private readonly TokenService _tokenService;


    public AuthService(ILogger<AuthService> logger, OltpDbContext dbContext, PasswordHasherProvider passwordHasherProvider, TokenService tokenService)
    {
        _logger = logger;
        _dbContext = dbContext;
        _passwordHasherProvider = passwordHasherProvider;
        _tokenService = tokenService;
    }

    //login method
    public async Task<IActionResult> login(AuthRequest request)
    {
		// check if the usser in the database
		var userInDb = _dbContext.Accounts.FirstOrDefault(u => u.Email == request.Email);
		if (userInDb is null)
			throw new Exception("Email ou Mot de passe invalid !");
		

		if (!_passwordHasherProvider.VerifyPasswordHash(request.Password, userInDb.PasswordHash, userInDb.PasswordSalt))
			throw new Exception("Email ou Mot de passe invalid !");
		

		var accessToken = _tokenService.CreateToken(userInDb);
		await _dbContext.SaveChangesAsync();

		var x = new AuthResponse
		{
			Token = accessToken,
		};
		return x;
	}

}
