using back.DTOs;
using back.Entities.Oltp;
using back.Repositories.Interfaces;
using back.Services.Interfaces;

namespace back.Services.Implementations;

/// <summary>
/// Service implementation for Customer business logic.
/// Calls repository for data access.
/// </summary>
public class CustomerService : ICustomerService
{
    private readonly ICustomerRepository _customerRepository;
    private readonly ILogger<CustomerService> _logger;

    public CustomerService(ICustomerRepository customerRepository, ILogger<CustomerService> logger)
    {
        _customerRepository = customerRepository;
        _logger = logger;
    }

    public async Task<IEnumerable<CustomerDto>> GetAllAsync()
    {
        var customers = await _customerRepository.GetAllAsync();
        return customers.Select(MapToDto);
    }

    public async Task<CustomerDto?> GetByIdAsync(int id)
    {
        var customer = await _customerRepository.GetByIdAsync(id);
        return customer == null ? null : MapToDto(customer);
    }

    public async Task<CustomerDto> CreateAsync(CreateCustomerDto dto)
    {
        // Check if email already exists
        var existing = await _customerRepository.GetByEmailAsync(dto.Email);
        if (existing != null)
        {
            throw new InvalidOperationException($"Customer with email '{dto.Email}' already exists.");
        }

        var customer = new Customer
        {
            FirstName = dto.FirstName,
            LastName = dto.LastName,
            Email = dto.Email,
            Phone = dto.Phone,
            Address = dto.Address,
            City = dto.City,
            Country = dto.Country,
            CreatedAt = DateTime.UtcNow
        };

        var created = await _customerRepository.AddAsync(customer);
        _logger.LogInformation("Customer created with ID {Id}", created.Id);
        return MapToDto(created);
    }

    public async Task<CustomerDto?> UpdateAsync(int id, UpdateCustomerDto dto)
    {
        var customer = await _customerRepository.GetByIdAsync(id);
        if (customer == null)
        {
            return null;
        }

        // Update only provided fields
        if (!string.IsNullOrEmpty(dto.FirstName))
            customer.FirstName = dto.FirstName;
        if (!string.IsNullOrEmpty(dto.LastName))
            customer.LastName = dto.LastName;
        if (!string.IsNullOrEmpty(dto.Email))
            customer.Email = dto.Email;
        if (dto.Phone != null)
            customer.Phone = dto.Phone;
        if (dto.Address != null)
            customer.Address = dto.Address;
        if (dto.City != null)
            customer.City = dto.City;
        if (dto.Country != null)
            customer.Country = dto.Country;

        var updated = await _customerRepository.UpdateAsync(customer);
        _logger.LogInformation("Customer updated with ID {Id}", updated.Id);
        return MapToDto(updated);
    }

    public async Task<bool> DeleteAsync(int id)
    {
        var result = await _customerRepository.DeleteAsync(id);
        if (result)
        {
            _logger.LogInformation("Customer deleted with ID {Id}", id);
        }
        return result;
    }

    /// <summary>
    /// Map entity to DTO.
    /// </summary>
    private static CustomerDto MapToDto(Customer customer)
    {
        return new CustomerDto
        {
            Id = customer.Id,
            FirstName = customer.FirstName,
            LastName = customer.LastName,
            Email = customer.Email,
            Phone = customer.Phone,
            Address = customer.Address,
            City = customer.City,
            Country = customer.Country,
            CreatedAt = customer.CreatedAt
        };
    }
}
