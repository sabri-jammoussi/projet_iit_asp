using back.Entities.Oltp;
using back.Repositories.Interfaces;
using Back.Data.Infrastructure.EF;
using Microsoft.EntityFrameworkCore;

namespace back.Repositories.Implementations;

/// <summary>
/// Repository implementation for OrderDetail entity.
/// Uses EF Core for data access.
/// </summary>
public class OrderDetailRepository : IOrderDetailRepository
{
    private readonly OltpDbContext _dbContext;

    public OrderDetailRepository(OltpDbContext dbContext)
    {
        _dbContext = dbContext;
    }

    public async Task<IEnumerable<OrderDetail>> GetAllAsync()
    {
        return await _dbContext.OrderDetails
            .Include(od => od.Product)
            .Include(od => od.Order)
            .AsNoTracking()
            .ToListAsync();
    }

    public async Task<OrderDetail?> GetByIdAsync(int id)
    {
        return await _dbContext.OrderDetails
            .Include(od => od.Product)
            .Include(od => od.Order)
            .FirstOrDefaultAsync(od => od.Id == id);
    }

    public async Task<IEnumerable<OrderDetail>> GetByOrderIdAsync(int orderId)
    {
        return await _dbContext.OrderDetails
            .Where(od => od.OrderId == orderId)
            .Include(od => od.Product)
            .AsNoTracking()
            .ToListAsync();
    }

    public async Task<OrderDetail> AddAsync(OrderDetail orderDetail)
    {
        _dbContext.OrderDetails.Add(orderDetail);
        await _dbContext.SaveChangesAsync();
        return orderDetail;
    }

    public async Task<OrderDetail> UpdateAsync(OrderDetail orderDetail)
    {
        _dbContext.OrderDetails.Update(orderDetail);
        await _dbContext.SaveChangesAsync();
        return orderDetail;
    }

    public async Task<bool> DeleteAsync(int id)
    {
        var orderDetail = await _dbContext.OrderDetails.FindAsync(id);
        if (orderDetail == null)
            return false;

        _dbContext.OrderDetails.Remove(orderDetail);
        await _dbContext.SaveChangesAsync();
        return true;
    }
}
